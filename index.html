<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deteksi Objek & Warna ‚Äî Final (HSV)</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">

<!-- TensorFlow + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
  :root{
    --brown:#6b3e2e;
    --milk:#d9b59d;
    --pink:#ff9db9;
    --bg:#f8e0e6;
  }
  html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg); display:flex; align-items:center; justify-content:center; }
  .card {
    width: 460px;
    background: linear-gradient(180deg,#fff7f5,#fff0f2);
    border-radius:18px;
    padding:18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    border:4px solid rgba(107,62,46,0.06);
    text-align:center;
  }
  h1 { margin:0 0 8px 0; color:var(--brown); font-size:20px; }
  .video-wrap { position:relative; width:380px; height:285px; margin:12px auto 8px; border-radius:12px; overflow:hidden; background:#fff; border:4px solid #e6cfc4; }
  video { width:100%; height:100%; object-fit:cover; display:block; }
  canvas { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
  .controls { display:flex; gap:10px; justify-content:center; margin-top:10px; }
  button { padding:10px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:600; color:#fff; background:var(--pink); box-shadow:0 6px 12px rgba(0,0,0,0.06); }
  button.secondary { background:#e7c6a3; color:#4e342e; }
  .status { margin-top:12px; display:flex; gap:12px; align-items:center; justify-content:center; }
  .status .box { width:46px; height:46px; border-radius:8px; border:3px solid #6b3e2e; background:#fff; }
  .status .text { min-width:220px; background:#fff7f7; padding:8px 12px; border-radius:10px; color:var(--brown); border:2px solid #e6cfc4; font-weight:600; }
  .footer-note { margin-top:10px; color:#6b3e2e; font-size:12px; opacity:0.9; }
  pre { white-space:pre-wrap; text-align:left; margin:8px 24px; color:var(--brown); font-size:13px; }
</style>
</head>
<body>

<div class="card">
  <h1>üç´üíó Deteksi Objek & Warna (Final)</h1>

  <div class="video-wrap" id="vwrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div class="controls">
    <button id="startBtn">Mulai Deteksi</button>
    <button id="stopBtn" class="secondary" disabled>Stop</button>
  </div>

  <div class="status">
    <div class="box" id="colorSample" title="Warna terdeteksi"></div>
    <div class="text" id="statusText">Model: belum dimuat ‚Ä¢ Warna: belum ada</div>
  </div>

  <div class="footer-note">Pastikan izinkan kamera dan pencahayaan cukup. Deteksi warna memakai HSV pada area tengah objek.</div>
  <pre id="log" style="display:none"></pre>
</div>

<script>
/* ====== Variabel UI ====== */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const statusText = document.getElementById('statusText');
const colorSample = document.getElementById('colorSample');
const logEl = document.getElementById('log');

/* ====== State ====== */
let model = null;
let stream = null;
let running = false;

/* ====== Load model awal (async) ====== */
statusText.innerText = 'Memuat model COCO-SSD...';
cocoSsd.load().then(m => {
  model = m;
  statusText.innerText = 'Model siap ‚Ä¢ Tekan "Mulai Deteksi"';
}).catch(err => {
  console.error(err);
  statusText.innerText = 'Gagal memuat model';
});

/* ====== Helper: Start Camera & ukuran canvas sync ====== */
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { width:1280, height:720 } , audio:false });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
    // set overlay canvas size to video actual
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    // also set container style to keep aspect ratio (handled by CSS object-fit)
    return true;
  } catch (e) {
    alert('Gagal membuka kamera ‚Äî izinkan akses kamera dan pastikan tidak sedang dipakai aplikasi lain.');
    console.error(e);
    return false;
  }
}

/* ====== Utility: RGB -> HEX ====== */
function rgbToHex(r,g,b){
  const toHex = v => ('0'+Math.round(v).toString(16)).slice(-2);
  return '#' + toHex(r) + toHex(g) + toHex(b);
}

/* ====== Utility: compute average RGB from ImageData ====== */
function avgRGBFromImageData(imgData){
  let r=0,g=0,b=0, count = imgData.data.length/4;
  for(let i=0;i<imgData.data.length;i+=4){
    r += imgData.data[i];
    g += imgData.data[i+1];
    b += imgData.data[i+2];
  }
  return { r: r/count, g: g/count, b: b/count };
}

/* ====== Convert RGB to HSV (H:0..360, S:0..1, V:0..1) ====== */
function rgbToHsv(r,g,b){
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  const d = max - min;
  let h = 0;
  if(d !== 0){
    if(max === r) h = ((g - b) / d) % 6;
    else if(max === g) h = (b - r) / d + 2;
    else h = (r - g) / d + 4;
  }
  h = Math.round(h * 60);
  if(h < 0) h += 360;
  const s = max === 0 ? 0 : d / max;
  const v = max;
  return { h, s, v };
}

/* ====== Map HSV to color name (ranges chosen empirically) ====== */
function hsvToColorName(h,s,v){
  // brightness checks
  if(v < 0.18) return 'Hitam';
  if(v > 0.92 && s < 0.18) return 'Putih';

  // hue ranges
  if((h >= 330 && h <= 360) || (h >= 0 && h <= 15)) return 'Merah';
  if(h > 15 && h <= 45) return 'Kuning';
  if(h > 45 && h <= 80) return 'Hijau';
  if(h > 80 && h <= 160) return 'Hijau (Lain)';
  if(h > 160 && h <= 260) return 'Biru';
  if(h > 260 && h <= 320) return 'Ungu';
  return 'Tidak diketahui';
}

/* ====== Detect color from bounding box region:
   - sample center-area (half width/height) to avoid background
   - min size check
===== */
function detectColorFromBBox(videoCtx, x,y,w,h){
  // enforce integer and clamping
  const sx = Math.max(0, Math.floor(x + w*0.25));
  const sy = Math.max(0, Math.floor(y + h*0.25));
  const sw = Math.max(2, Math.floor(w*0.5));
  const sh = Math.max(2, Math.floor(h*0.5));
  // if area too small, return null
  if(sw * sh < 50) return null;

  const imgData = videoCtx.getImageData(sx, sy, sw, sh);
  const avg = avgRGBFromImageData(imgData);
  const hsv = rgbToHsv(avg.r, avg.g, avg.b);
  const name = hsvToColorName(hsv.h, hsv.s, hsv.v);
  return { name, rgb: avg, hex: rgbToHex(avg.r, avg.g, avg.b), hsv };
}

/* ====== Main detection loop ====== */
async function detectionLoop(){
  if(!running) return;

  // draw current video frame to overlay full-size (we'll draw boxes on it)
  ctx.clearRect(0,0,overlay.width, overlay.height);
  ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

  // run model on the video element (faster and recommended)
  let predictions = [];
  try {
    predictions = await model.detect(video);
  } catch(err) {
    console.error('Model detect error', err);
  }

  if(predictions && predictions.length){
    // draw only top 3 for performance/readability
    const top = predictions.slice(0, 4);
    let statusLines = [];
    for(const p of top){
      const [x,y,w,h] = p.bbox;
      // draw box
      ctx.lineWidth = Math.max(2, Math.round(overlay.width/320));
      ctx.strokeStyle = '#ff4f8b';
      ctx.fillStyle = '#ff4f8b';
      ctx.strokeRect(x, y, w, h);
      // detect color from center area
      const detected = detectColorFromBBox(ctx, x, y, w, h);
      let colorLabel = 'Tidak diketahui';
      let hex = null;
      if(detected){
        colorLabel = detected.name;
        hex = detected.hex;
      }
      // label
      const label = `${p.class} (${(p.score*100).toFixed(1)}%) - ${colorLabel}`;
      ctx.font = `${14}px Poppins`;
      ctx.fillText(label, x + 6, y > 18 ? y - 8 : y + 18);
      statusLines.push(label);
      // update sample square only for first object
      if(top.indexOf(p) === 0){
        if(hex){
          colorSample.style.background = hex;
          colorSample.style.borderColor = '#6b3e2e';
          statusText.innerText = `Objek: ${p.class} ‚Ä¢ Warna: ${colorLabel} ‚Ä¢ ${hex}`;
          statusText.style.color = 'var(--brown)';
        } else {
          colorSample.style.background = '#fff';
          statusText.innerText = `Objek: ${p.class} ‚Ä¢ Warna: Tidak diketahui`;
        }
      }
    }
  } else {
    // nothing detected
    colorSample.style.background = '#fff';
    statusText.innerText = 'Tidak ada objek terdeteksi';
  }

  requestAnimationFrame(detectionLoop);
}

/* ====== Start / Stop buttons ====== */
startBtn.addEventListener('click', async () => {
  if(!model){
    alert('Model belum siap, tunggu beberapa detik lalu coba lagi.');
    return;
  }
  startBtn.disabled = true;
  const ok = await startCamera();
  if(!ok){ startBtn.disabled = false; return; }
  running = true;
  stopBtn.disabled = false;
  statusText.innerText = 'Mendeteksi...';
  detectionLoop();
});

stopBtn.addEventListener('click', () => {
  running = false;
  stopBtn.disabled = true;
  startBtn.disabled = false;
  if(stream) stream.getTracks().forEach(t => t.stop());
  statusText.innerText = 'Kamera dihentikan';
  colorSample.style.background = '#fff';
  // clear overlay
  ctx.clearRect(0,0,overlay.width, overlay.height);
});
</script>
</body>
</html>
