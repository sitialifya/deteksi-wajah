<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Deteksi Objek & Warna - TensorFlow.js</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f1f1f1;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    h1 {
        margin-top: 20px;
        margin-bottom: 10px;
    }

    #wrapper {
        position: relative;
        display: inline-block;
        margin-top: 20px;
    }

    #video, #canvas {
        position: absolute;
        top: 0; left: 0;
        width: 640px;
        height: 480px;
        border-radius: 10px;
    }

    #canvas {
        pointer-events: none; /* overlay, tidak bisa diklik */
    }

    #btnArea {
        margin-top: 25px;
    }

    button {
        padding: 10px 18px;
        font-size: 15px;
        margin: 0 5px;
        cursor: pointer;
    }

    #status {
        margin-top: 15px;
        font-size: 16px;
    }
</style>
</head>
<body>

<h1>Deteksi Objek & Warna</h1>

<div id="wrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
</div>

<div id="btnArea">
    <button id="startBtn">Mulai Kamera</button>
    <button id="stopBtn" disabled>Stop</button>
</div>

<div id="status">Memuat model...</div>

<!-- Load TensorFlow.js + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
let model;
let stream;
let running = false;

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");

canvas.width = 640;
canvas.height = 480;

// ----------------- LOAD MODEL -----------------
(async () => {
    statusEl.textContent = "Memuat model COCO-SSD...";
    model = await cocoSsd.load();
    statusEl.textContent = "Model siap. Klik 'Mulai Kamera'.";
})();

// ----------------- START CAMERA -----------------
document.getElementById("startBtn").onclick = async () => {
    stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480 }
    });

    video.srcObject = stream;

    running = true;

    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;

    // Tunggu sampai video siap frame (WAJIB)
    video.onloadeddata = () => detect();
};

// ----------------- STOP CAMERA -----------------
document.getElementById("stopBtn").onclick = () => {
    running = false;
    if (stream) stream.getTracks().forEach(t => t.stop());

    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;

    statusEl.textContent = "Kamera berhenti.";
};

// ----------------- COLOR DETECTION -----------------
function getColorName(r, g, b) {
    if (r < 60 && g < 60 && b < 60) return "Black";
    if (r > 200 && g > 200 && b > 200) return "White";
    if (r > 180 && g < 80 && b < 80) return "Red";
    if (r > 180 && g > 110 && b < 80) return "Yellow";
    if (r < 80 && g > 150 && b < 80) return "Green";
    if (r < 80 && g < 80 && b > 150) return "Blue";
    return "Other";
}

function detectColor(x, y, w, h) {
    const data = ctx.getImageData(x, y, w, h).data;

    let r = 0, g = 0, b = 0, count = 0;

    for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
    }

    r /= count; g /= count; b /= count;

    return getColorName(r, g, b);
}

// ----------------- DETECTION LOOP -----------------
async function detect() {
    if (!running || !model) return;

    const predictions = await model.detect(video);

    // Gambar dari video ke canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    predictions.forEach(pred => {
        let [x, y, w, h] = pred.bbox;
        const label = pred.class;

        // ambil warna
        const color = detectColor(x, y, w, h);

        // gambar kotak
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);

        // tulis label + warna
        ctx.fillStyle = "yellow";
        ctx.font = "16px Arial";
        ctx.fillText(`${label} (${color})`, x, y - 5);
    });

    statusEl.textContent = `Objek terdeteksi: ${predictions.length}`;

    requestAnimationFrame(detect);
}
</script>
</body>
</html>
