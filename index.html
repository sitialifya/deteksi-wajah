<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Deteksi Objek & Warna - TensorFlow.js</title>

<style>
    body { font-family: Arial, sans-serif; background:#f1f1f1; padding:20px; }
    h1 { font-size:22px; }
    #video, #canvas { border-radius:10px; background:#000; }
    .row { display:flex; gap:20px; flex-wrap:wrap; }
    .panel { max-width:400px; }
    #log { white-space:pre-line; font-size:14px; }
</style>
</head>
<body>

<h1>Deteksi Objek & Warna (TensorFlow.js - COCO-SSD)</h1>

<div class="row">
    <div class="panel">
        <video id="video" width="640" height="480" autoplay muted playsinline></video>
        <canvas id="canvas" width="640" height="480"></canvas>

        <div style="margin-top:10px;">
            <button id="startBtn">Mulai Kamera</button>
            <button id="stopBtn" disabled>Stop</button>
        </div>
    </div>

    <div class="panel">
        <h3>Status</h3>
        <div id="status">Memuat TensorFlow.js...</div>

        <h3>Log</h3>
        <div id="log"></div>
    </div>
</div>

<!-- TensorFlow.js + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");

let model = null;
let detectLoop = null;
let stream = null;

function log(t) {
    logEl.textContent += t + "\n";
    logEl.scrollTop = logEl.scrollHeight;
}

async function loadModel() {
    statusEl.textContent = "Memuat model COCO-SSD...";
    model = await cocoSsd.load();
    statusEl.textContent = "Model siap!";
    log("Model COCO-SSD berhasil dimuat.");
}
loadModel();

// Mulai kamera
startBtn.addEventListener("click", async () => {
    stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480 }
    });
    video.srcObject = stream;

    startBtn.disabled = true;
    stopBtn.disabled = false;

    runDetection();
});

// Stop kamera
stopBtn.addEventListener("click", () => {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    cancelAnimationFrame(detectLoop);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    statusEl.textContent = "Kamera berhenti.";
});

function getDominantColor(imageData) {
    // hitung rata-rata RGB
    let r=0, g=0, b=0, count=0;
    for (let i=0; i < imageData.data.length; i+=4) {
        r += imageData.data[i];
        g += imageData.data[i+1];
        b += imageData.data[i+2];
        count++;
    }
    r /= count; g /= count; b /= count;

    return rgbToName(r, g, b);
}

function rgbToName(r, g, b) {
    if (r<60 && g<60 && b<60) return "black";
    if (r>200 && g>200 && b>200) return "white";

    if (r>180 && g<80 && b<80) return "red";
    if (r>180 && g>110 && b<80) return "yellow";
    if (r<100 && g>150 && b<100) return "green";
    if (r<100 && g<100 && b>150) return "blue";
    if (r>150 && g<100 && b>150) return "purple";
    return "other";
}

async function runDetection() {
    if (!model) {
        statusEl.textContent = "Model belum siap...";
        detectLoop = requestAnimationFrame(runDetection);
        return;
    }

    detectLoop = requestAnimationFrame(runDetection);

    const predictions = await model.detect(video);
    
    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    predictions.forEach(p => {
        const [x, y, w, h] = p.bbox;

        // ambil ROI (region of interest) untuk hitung warna
        const roi = ctx.getImageData(x, y, w, h);
        const colorName = getDominantColor(roi);

        // gambar kotak
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);

        // label objek + warna
        ctx.fillStyle = "yellow";
        ctx.font = "16px Arial";
        ctx.fillText(`${p.class} (${colorName})`, x, y > 20 ? y-5 : y+20);
    });

    statusEl.textContent = `Terdeteksi: ${predictions.length} objek`;
}
</script>

</body>
</html>
